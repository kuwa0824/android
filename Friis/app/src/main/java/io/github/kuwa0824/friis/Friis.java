package io.github.kuwa0824.friis;

public class Friis {

	public static double recv_power(double Fr, double D, double Gt, double Gr, double Pt) {
		double Pr = 20.0*Math.log10(0.3/Fr/(4.0*Math.PI*D))+Gt+Gr+Pt;
		return Pr;
	}

    public static double e_field_strength(double Pr, double Fr, double Gr) {
        double Er = 10.0*Math.log10(Math.pow(10.0,(Pr-Gr-20.0*Math.log10(0.3/Fr)+10.0*Math.log10(4.0*Math.PI))/10.0)*0.12*Math.PI)+120.0;
        return Er;
    }
    
	public static double snr(double Pr, double NF, double BW) {
		double sn = Pr-(-174.0+10.0*Math.log10(BW)+60.0+NF);
		return sn;
	}

	private static double tau(double rp, double rt, double p1, double p2, double p3, double p4) {
		double x = Math.exp(p3*(1-rp)+p4*(1-rt));
		x *= Math.pow(rp, p1);
		x *= Math.pow(rt, p2);
		return x;
	}

	private static double gf(double Fr, double Fi) {
		double x = 1.0+Math.pow((Fr-Fi)/(Fr+Fi),2);
		return x;
	}

	// Attenuation by atmospheric gases
	//     Reference : ITU-R P.676-9
	public static double atm_att(double Fr, double hpa, double tK, double pv) {
		double rp = hpa/1013;
		double rt = 288.0/tK;
		double x = -1.0;
		double y = -1.0;
		if(Fr <= 0 || Fr > 350) {
			return x;
		} else if(Fr < 54) {
			double t1 = tau(rp, rt, 0.0717, -1.8132, 0.0156, -1.6515);
			double t2 = tau(rp, rt, 0.5146, -4.6368, -0.1921, -5.7416);
			double t3 = tau(rp, rt, 0.3414, -6.5851, 0.2130, -8.5854);
			x = 7.2*Math.pow(rt,2.8)/(Math.pow(Fr,2)+0.34*Math.pow(rp,2)*Math.pow(rt,1.6));
			x += 0.62*t3/(Math.pow(54.0-Fr,1.16*t1)+0.83*t2);
			x *= Math.pow(Fr,2)*Math.pow(rp,2)*0.001;
		} else if(Fr < 60) {
			double c54 = 2.192*tau(rp, rt, 1.8286, -1.9487, 0.4051, -2.8509);
			double c58 = 12.59*tau(rp, rt, 1.0045, 3.5610, 0.1588, 1.2834);
			double c60 = 15.0*tau(rp, rt, 0.9003, 4.1335, 0.0427, 1.6088);
			x = Math.log(c54)/24.0*(Fr-58)*(Fr-60);
			x -= Math.log(c58)/8.0*(Fr-54)*(Fr-60);
			x += Math.log(c60)/12.0*(Fr-54)*(Fr-58);
			x = Math.exp(x);
		} else if(Fr < 62) {
			double c60 = 15.0*tau(rp, rt, 0.9003, 4.1335, 0.0427, 1.6088);
			double c62 = 14.28*tau(rp, rt, 0.9886, 3.4176, 0.1827, 1.3429);
			x = c60+(c62-c60)*(Fr-60)/2.0;
		} else if(Fr < 66) {
			double c62 = 14.28*tau(rp, rt, 0.9886, 3.4176, 0.1827, 1.3429);
			double c64 = 6.819*tau(rp, rt, 1.4320, 0.6258, 0.3177, -0.5914);
			double c66 = 1.908*tau(rp, rt, 2.0717, -4.1404, 0.4910, -4.8718);
			x = Math.log(c62)/8.0*(Fr-64)*(Fr-66);
			x -= Math.log(c64)/4.0*(Fr-62)*(Fr-66);
			x += Math.log(c66)/8.0*(Fr-62)*(Fr-64);
			x = Math.exp(x);
		} else if(Fr < 120) {
			double t4 = tau(rp, rt, -0.0112, 0.0092, -0.1033, -0.0009);
			double t5 = tau(rp, rt, 0.2705, -2.7192, -0.3016, -4.1033);
			double t6 = tau(rp, rt, 0.2445, -5.9191, 0.0422, -8.0719);
			double t7 = tau(rp, rt, -0.1833, 6.5589, -0.2402, 6.131);
			x = 0.000302*Math.pow(rt,3.5);
			x += 0.283*Math.pow(rt,3.8)/(Math.pow(Fr-118.75,2)+2.91*Math.pow(rp,2)*Math.pow(rt,1.6));
			x += 0.502*t6*(1-0.0163*t7*(Fr-66))/(Math.pow(Fr-66,1.4346*t4)+1.15*t5);
			x *= Math.pow(Fr,2)*Math.pow(rp,2)*0.001;
		} else {
			x = 0.000302/(1.0+0.000019*Math.pow(Fr,1.5));
			x += 0.283*Math.pow(rt,0.3)/(Math.pow(Fr-118.75,2)+2.91*Math.pow(rp,2)*Math.pow(rt,1.6));
			x *= Math.pow(Fr,2)*Math.pow(rp,2)*Math.pow(rt,3.5)*0.001;
			x -= 0.00306*tau(rp, rt, 3.211, -14.94, 1.583, -16.37);
		}
		double n1 = 0.955*rp*Math.pow(rt,0.68)+0.006*pv;
		double m1 = Math.pow(n1,2);
		double n2 = 0.735*rp*Math.pow(rt,0.5)+0.0353*Math.pow(rt,4)*pv;
		y = 3.98*n1*Math.exp(2.23*(1-rt))/(Math.pow(Fr-22.235,2)+9.42*m1)*gf(Fr,22.0);
		y += 11.96*n1*Math.exp(0.7*(1-rt))/(Math.pow(Fr-183.31,2)+11.14*m1);
		y += 0.081*n1*Math.exp(6.44*(1-rt))/(Math.pow(Fr-321.226,2)+6.29*m1);
		y += 3.66*n1*Math.exp(1.6*(1-rt))/(Math.pow(Fr-325.153,2)+9.22*m1);
		y += 25.37*n1*Math.exp(1.09*(1-rt))/Math.pow(Fr-380,2);
		y += 17.4*n1*Math.exp(1.46*(1-rt))/Math.pow(Fr-448,2);
		y += 844.6*n1*Math.exp(0.17*(1-rt))/Math.pow(Fr-557,2)*gf(Fr,557.0);
		y += 290*n1*Math.exp(0.41*(1-rt))/Math.pow(Fr-752,2)*gf(Fr,752.0);
		y += 83328*n2*Math.exp(0.99*(1-rt))/Math.pow(Fr-1780,2)*gf(Fr,1780.0);
		y *= Math.pow(Fr,2)*Math.pow(rt,2.5)*pv*0.0001;
		return x+y;
	}

	// Attenuation due to rain
	//     Reference : ITU-R P.838-3
	public static double rain_att(double Fr, double rr) {
		if(Fr <= 0 || Fr > 350) {
			return -1.0;
		}
		double k = 0;
		double a = 0;
		int i;
		for(i=0; i<110; i++) {
			if(ratt_f[i] > Fr) {
				break;
			}
		}
		if(i == 0) {
			k = ratt_k[0];
			a = ratt_a[0];
		} else if(i >= 110) {
			k = ratt_k[109];
			a = ratt_a[109];
		} else {
			double f1 = ratt_f[i-1];
			double f2 = ratt_f[i];
			double k1 = ratt_k[i-1];
			double k2 = ratt_k[i];
			double a1 = ratt_a[i-1];
			double a2 = ratt_a[i];
			k = (k2*(Fr-f1)+k1*(f2-Fr))/(f2-f1);
			a = (a2*(Fr-f1)+a1*(f2-Fr))/(f2-f1);
		}
		double x = k * Math.pow(rr, a);
		return x;
	}

	private static double ratt_f[] = {
		1, 1.5, 2, 2.5, 3, 3.5, 4, 4.5, 5, 5.5,
		6, 7, 8, 9, 10, 11, 12, 13, 14, 15,
		16, 17, 18, 19, 20, 21, 22, 23, 24, 25,
		26, 27, 28, 29, 30, 31, 32, 33, 34, 35,
		36, 37, 38, 39, 40, 41, 42, 43, 44, 45,
		46, 47, 48, 49, 50, 51, 52, 53, 54, 55,
		56, 57, 58, 59, 60, 61, 62, 63, 64, 65,
		66, 67, 68, 69, 70, 71, 72, 73, 74, 75,
		76, 77, 78, 79, 80, 81, 82, 83, 84, 85,
		86, 87, 88, 89, 90, 91, 92, 93, 94, 95,
		96, 97, 98, 99, 100, 120, 150, 200, 300, 400};
	private static double ratt_k[] = {
		0.00002835, 0.00005085, 0.00009225, 0.00013925, 0.0001666, 0.00017505, 0.0001766, 0.00018435, 0.0002295, 0.0003512,
		0.0005967, 0.00167, 0.0037825, 0.007113, 0.01173, 0.017515, 0.024205, 0.031535, 0.03932, 0.047445,
		0.055905, 0.064715, 0.07393, 0.08363, 0.093875, 0.10475, 0.11625, 0.1285, 0.14145, 0.1552,
		0.16965, 0.18485, 0.20075, 0.2174, 0.2347, 0.25265, 0.2712, 0.29025, 0.30985, 0.3299,
		0.35035, 0.3711, 0.39225, 0.41365, 0.43525, 0.45695, 0.47885, 0.5008, 0.52275, 0.5448,
		0.5667, 0.58865, 0.61045, 0.63205, 0.6536, 0.6749, 0.69605, 0.717, 0.7377, 0.7581,
		0.77825, 0.79815, 0.81775, 0.8371, 0.85605, 0.87475, 0.89315, 0.9112, 0.9289, 0.9463,
		0.9634, 0.98015, 0.99655, 1.01265, 1.0284, 1.04385, 1.05895, 1.07375, 1.08825, 1.1024,
		1.1162, 1.1298, 1.14305, 1.156, 1.1686, 1.181, 1.19305, 1.20485, 1.2164, 1.2277,
		1.2387, 1.2494, 1.25985, 1.2701, 1.2801, 1.2898, 1.2993, 1.3086, 1.3177, 1.32655,
		1.33515, 1.34355, 1.35175, 1.35975, 1.36755, 1.48885, 1.58595, 1.64105, 1.6286, 1.584};
	private static double ratt_a[] = {
		0.909401235, 0.949191052, 1.002895827, 1.061814327, 1.136965066, 1.231139589, 1.354730323, 1.506314321, 1.609513159, 1.622537315,
		1.582969532, 1.478226796, 1.385574686, 1.303271264, 1.237128346, 1.188156066, 1.151615988, 1.123128143, 1.100249797, 1.081447919,
		1.065706815, 1.052257923, 1.040460598, 1.029780605, 1.019891712, 1.010399857, 1.001247097, 0.992222724, 0.983300424, 0.974406057,
		0.965625258, 0.956863863, 0.948235542, 0.939583533, 0.931124712, 0.922760162, 0.914540597, 0.906417554, 0.898495127, 0.890725099,
		0.883152419, 0.8758327, 0.868664168, 0.86169386, 0.854927249, 0.848310307, 0.841944106, 0.835782109, 0.829817456, 0.824055433,
		0.818442827, 0.813032235, 0.807821632, 0.802711922, 0.797854284, 0.79309554, 0.788587192, 0.784180893, 0.779874393, 0.775768381,
		0.771763412, 0.76795821, 0.764203082, 0.760599128, 0.757145178, 0.753791523, 0.750538543, 0.747385322, 0.744332329, 0.741379917,
		0.738577092, 0.735774815, 0.733123195, 0.730521503, 0.728019594, 0.725567663, 0.723216417, 0.720914561, 0.718713356, 0.716562083,
		0.714511127, 0.712510126, 0.710559057, 0.708657971, 0.706807239, 0.705006622, 0.703255781, 0.701555115, 0.699904382, 0.69830391,
		0.696753419, 0.695253001, 0.693802429, 0.692401929, 0.691001594, 0.68965126, 0.68835097, 0.687050699, 0.685800455, 0.684600109,
		0.683399895, 0.682299699, 0.68114951, 0.680049344, 0.678999177, 0.662447658, 0.647996778, 0.636246138, 0.6279, 0.6259};

}

